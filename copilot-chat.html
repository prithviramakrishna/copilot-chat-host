<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Copilot Chat</title>
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
    }
    #webchat {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="webchat"></div>

  <script>
    let directLine;

    async function getDirectLineTokenAndUrl() {
      const tokenEndpoint = 'https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr5d4_agent1/directline/token?api-version=2022-03-01-preview';
      const response = await fetch(tokenEndpoint);
      const { token } = await response.json();

      const settingsRes = await fetch('https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/regionalchannelsettings?api-version=2022-03-01-preview');
      const settingsJson = await settingsRes.json();
      const directline = settingsJson?.channelUrlsById?.directline;

      return { token, domain: new URL('v3/directline', directline).toString() };
    }

    async function renderBot(contextPayload = null) {
      const { token, domain } = await getDirectLineTokenAndUrl();

      directLine = window.WebChat.createDirectLine({ token, domain });

      window.WebChat.renderWebChat(
        {
          directLine,
          userID: 'user1',
          locale: 'en',
          styleOptions: { hideUploadButton: false }
        },
        document.getElementById('webchat')
      );

      console.log('‚úÖ Bot rendered');

      if (contextPayload) {
        directLine.postActivity({
          type: 'event',
          name: 'startConversation',
          from: { id: 'user1' },
          value: contextPayload
        }).subscribe();
        console.log('üì§ Sent context payload to bot:', contextPayload);
      }
    }

    // üîÑ Wait for context from parent
   window.addEventListener("message", (event) => {
  try {
    const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

    if (data?.method === "openframe_communication") {
      const parsed = JSON.parse(data.payload);

      // ‚úÖ Extract incidentId from the URL
      let incidentId = null;
      const match = parsed.url?.match(/incident\/([a-f0-9]+)/i);
      if (match) {
        incidentId = match[1]; // e.g., "57af7aec73d423002728660c4cf6a71c"
      }

      const payload = {
        incidentId: incidentId,
        url: parsed.url,
        source: parsed.source,
        sourceId: parsed.sourceId,
        configType: parsed.configType,
        locale: 'en',
        localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      };

      console.log("‚úÖ Final payload with incidentId:", payload);

      renderBot(payload); // Start bot with enriched payload
    }
  } catch (e) {
    console.error("‚ùå Error handling context message:", e);
  }
});
    console.log("üëÇ Listening for context message...");
  </script>
</body>
</html>
