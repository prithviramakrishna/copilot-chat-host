<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Copilot Chat</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Segoe UI, sans-serif;
      }

      #chat-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #ffffff;
      }

      #webchat {
        flex: 1;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="chat-container">
      <div id="webchat"></div>
    </div>

    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script>
      async function getDirectLineTokenAndUrl() {
        const tokenEndpoint = 'https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr5d4_agent1/directline/token?api-version=2022-03-01-preview';
        const response = await fetch(tokenEndpoint);
        const { token } = await response.json();

        const settingsRes = await fetch('https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/regionalchannelsettings?api-version=2022-03-01-preview');
        const { channelUrlsById: { directline } } = await settingsRes.json();

        return { token, domain: new URL('v3/directline', directline).toString() };
      }

      async function startWebChat() {
        const webchatDiv = document.getElementById('webchat');
        const { token, domain } = await getDirectLineTokenAndUrl();
        const directLine = WebChat.createDirectLine({ token, domain });
        const locale = document.documentElement.lang || 'en';
        const incidentId = params.get('incidentId');

        WebChat.renderWebChat({
          directLine,
          locale,
          styleOptions: {
            hideUploadButton: true
          }
        }, webchatDiv);

        directLine.connectionStatus$.subscribe(status => {
          if (status === 2) {
            directLine.postActivity({
              type: 'event',
              name: 'startConversation',
              from: { id: 'user1' },
              value: {
                localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                locale,
                userName: 'John Doe',
                userId: Date.now().toString(),
                currentUrl: window.location.href,
                incidentId: incidentId
              }
            }).subscribe();
          }
        });
      }
      startWebChat();
    </script>
  </body>
</html>
