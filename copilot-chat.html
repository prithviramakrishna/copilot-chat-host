<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Copilot Chat</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Segoe UI, sans-serif;
      }

      #chat-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #ffffff;
      }

      #webchat {
        flex: 1;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="chat-container">
      <div id="webchat"></div>
    </div>

    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script>
      let directLine;

      async function getDirectLineTokenAndUrl() {
        const tokenEndpoint = 'https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr5d4_agent1/directline/token?api-version=2022-03-01-preview';
        const response = await fetch(tokenEndpoint);
        const { token } = await response.json();

        const settingsRes = await fetch('https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/regionalchannelsettings?api-version=2022-03-01-preview');
        const settingsJson = await settingsRes.json();
        const directline = settingsJson?.channelUrlsById?.directline;

        return { token, domain: new URL('v3/directline', directline).toString() };
      }

      async function startWebChat() {
        try {
          const webchatDiv = document.getElementById('webchat');
          const { token, domain } = await getDirectLineTokenAndUrl();
          directLine = WebChat.createDirectLine({ token, domain });

          WebChat.renderWebChat({
            directLine,
            locale: 'en',
            styleOptions: {
              hideUploadButton: true
            }
          }, webchatDiv);

          console.log("‚úÖ Copilot WebChat initialized");
        } catch (err) {
          console.error("‚ùå Failed to initialize WebChat:", err);
        }
      }

      // üîÅ Listen for OpenFrame postMessage from Classic UI
      window.addEventListener("message", (event) => {
        try {
          const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
          if (data?.method === "openframe_communication") {
            const payload = JSON.parse(data.payload);

            console.log("üì© Received from Classic Client Script:", payload);

            if (directLine) {
              directLine.postActivity({
                type: 'event',
                name: 'recordContext', // Event name should match bot trigger
                from: { id: 'user1' },
                value: {
                  incidentId: payload.recordId,
                  objectType: payload.objectType,
                  source: payload.source,
                  sourceId: payload.sourceId
                }
              }).subscribe(
                id => console.log("üì§ Event sent to bot:", id),
                err => console.error("‚ùå Failed to send event:", err)
              );
            } else {
              console.warn("‚ö†Ô∏è DirectLine not ready when message received.");
            }
          }
        } catch (e) {
          console.error("‚ùå Error handling OpenFrame message:", e);
        }
      });

      // üöÄ Start WebChat
      startWebChat();
    </script>
  </body>
</html>
