<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Copilot Chat</title>
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
    }

    #container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }

    #webchat {
      flex: 1;
      width: 100%;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="webchat"></div>
  </div>

  <script>
    const sessionMap = new Map();
    const SESSION_TIMEOUT_MS = 25 * 60 * 1000;

    async function getDirectLineTokenAndUrl() {
      const tokenEndpoint = 'https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr5d4_agent1/directline/token?api-version=2022-03-01-preview';
      const response = await fetch(tokenEndpoint);
      const { token } = await response.json();

      const settingsRes = await fetch('https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/regionalchannelsettings?api-version=2022-03-01-preview');
      const settingsJson = await settingsRes.json();
      const directline = settingsJson?.channelUrlsById?.directline;

      return { token, domain: new URL('v3/directline', directline).toString() };
    }

   function renderWebChat(session, incidentId) {
      const container = document.getElementById('webchat');
      container.innerHTML = "";
    
      // Load from localStorage
      const savedTranscript = localStorage.getItem(`chat_history_${incidentId}`);
      const activities = savedTranscript ? JSON.parse(savedTranscript) : [];
    
      // Start Web Chat
      window.WebChat.renderWebChat(
        {
          directLine: session.directLine,
          userID: session.userID,
          locale: session.locale,
          styleOptions: session.styleOptions,
          store: session.store,
          activities // üëà Inject saved chat
        },
        container
      );
    
      console.log("‚úÖ Bot rendered with restored chat for", session.userID);
    }

    async function startWebChat(contextPayload) {
      const incidentKey = contextPayload.incidentId;
      const userID = `user_${incidentKey}`;
      const container = document.getElementById('webchat');
      container.innerHTML = "";

      if (sessionMap.has(incidentKey)) {
        const existingSession = sessionMap.get(incidentKey);
        const now = Date.now();

        if (now - existingSession.startTime < SESSION_TIMEOUT_MS) {
          console.log("‚ôªÔ∏è Reusing session for", incidentKey);
          renderWebChat(existingSession, incidentKey);
          return;
        } else {
          console.log("‚è∞ Session expired. Creating new DirectLine.");
          sessionMap.delete(incidentKey);
        }
      }

      const { token, domain } = await getDirectLineTokenAndUrl();
      const directLine = window.WebChat.createDirectLine({ token, domain });
      const store = window.WebChat.createStore();
      const transcript = [];

      store.subscribe(() => {
        const action = store.getState().lastAction;
        if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY' || action.type === 'WEB_CHAT/SEND_MESSAGE') {
          transcript.push(action.payload.activity);
          localStorage.setItem(`chat_history_${incidentKey}`, JSON.stringify(transcript));
        }
      });

      const session = {
        directLine,
        userID: userID,
        locale: 'en',
        styleOptions: { hideUploadButton: false },
        startTime: Date.now(),
        store
      };

      sessionMap.set(incidentKey, session);
      renderWebChat(session, incidentKey);

      directLine.connectionStatus$.subscribe(status => {
        if (status === 2) {
          directLine.postActivity({
            type: 'event',
            name: 'startConversation',
            from: { id: userID },
            value: { incidentId: contextPayload.incidentId }
          }).subscribe(() => {
            console.log("üöÄ startConversation event sent with:", contextPayload);
          });
        }
      });
    }

    window.addEventListener("message", (event) => {
      try {
        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
        console.log("üì© message received", data);

        if (data?.eventName === "openframe_communication") {
          const parsed = JSON.parse(data.args);
          let incidentId = null;
          const match = parsed.url?.match(/incident\/([a-f0-9]+)/i);
          if (match) incidentId = match[1];

          const payload = {
            locale: 'en',
            localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            incidentId: incidentId,
            url: parsed.url,
            source: parsed.source,
            sourceId: parsed.sourceId,
            configType: parsed.configType
          };

          console.log("‚úÖ Final context payload:", payload);
          if (payload.incidentId) {
            startWebChat(payload);
          }
        }

        if (data?.method === "close_frame") {
          console.log("üîÅ Reloading frame...");
          window.location.reload();
        }
      } catch (e) {
        console.error("‚ùå Failed to handle OpenFrame message", e);
      }
    });

    console.log("üëÇ Waiting for ServiceNow context...");
  </script>
</body>
</html>
