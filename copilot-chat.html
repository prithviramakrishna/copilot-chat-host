<!DOCTYPE html>
<html lang="en">
<head>
  <title>Copilot Chat</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Segoe UI, sans-serif;
    }

    #chat-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: #ffffff;
    }

    #webchat {
      flex: 1;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="webchat"></div>
  </div>

  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <script>
    let directLine;
    let incidentIdFromSN = null;
    let directLineConnected = false;
    let startConversationSent = false;

    // Listen for incidentId from ServiceNow via postMessage
    window.addEventListener("message", (event) => {
      if (event.data?.type === "incidentContext") {
        incidentIdFromSN = event.data.payload?.incidentId || null;
        tryStartConversation();
      }
    });

    function tryStartConversation() {
      if (directLineConnected && incidentIdFromSN && !startConversationSent) {
        directLine.postActivity({
          type: 'event',
          name: 'startConversation',
          from: { id: 'user1' },
          value: {
            localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            locale: document.documentElement.lang || 'en',
            userName: 'John Doe',
            userId: Date.now().toString(),
            currentUrl: window.location.href,
            incidentId: incidentIdFromSN // This must match the variable name in Copilot
          }
        }).subscribe(() => {
          startConversationSent = true;
        });
      }
    }

    async function getDirectLineTokenAndUrl() {
      const tokenEndpoint = 'https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr5d4_agent1/directline/token?api-version=2022-03-01-preview';
      const response = await fetch(tokenEndpoint);
      const { token } = await response.json();

      const settingsRes = await fetch('https://292d760cb79fe74db3cfbeb6da7b7d.0a.environment.api.powerplatform.com/powervirtualagents/regionalchannelsettings?api-version=2022-03-01-preview');
      const { channelUrlsById: { directline } } = await settingsRes.json();

      return { token, domain: new URL('v3/directline', directline).toString() };
    }

    async function startWebChat() {
      const webchatDiv = document.getElementById('webchat');
      const { token, domain } = await getDirectLineTokenAndUrl();
      directLine = WebChat.createDirectLine({ token, domain });
      const locale = document.documentElement.lang || 'en';

      WebChat.renderWebChat({
        directLine,
        locale,
        styleOptions: {
          hideUploadButton: true
        }
      }, webchatDiv);

      directLine.connectionStatus$.subscribe(status => {
        if (status === 2) {
          directLineConnected = true;
          tryStartConversation(); // If context already received
        }
      });
    }

    startWebChat();
  </script>
</body>
</html>
