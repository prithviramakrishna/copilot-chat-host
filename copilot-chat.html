<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Copilot Chat</title>
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        font-family: Segoe UI, sans-serif;
      }
      #banner {
        align-items: center;
        background-color: #001931;
        display: flex;
        height: 50px;
        color: white;
        padding: 0 20px;
      }
      #clipboard-prompts {
        padding: 10px;
        background: #f4f4f4;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      #clipboard-prompts button {
        padding: 8px 12px;
        background-color: #001931;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      #webchat {
        height: calc(100% - 100px);
        overflow: hidden;
        position: fixed;
        top: 100px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="banner">
      <h1>Copilot Assistant</h1>
    </div>
    <div id="clipboard-prompts"></div>
    <div id="webchat" role="main"></div>

    <script>
      (async function () {
        const styleOptions = {
          hideUploadButton: true,
          botAvatarInitials: 'BF',
          botAvatarBackgroundColor: '#001931',
          userAvatarBackgroundColor: 'gold',
          userAvatarInitials: 'You'
        };

        const incidentId = new URLSearchParams(window.location.search).get("incidentId") || "default_incident";
        const cacheKey = `chat_${incidentId}`;
        const tokenEndpointURL = new URL(
          'https://ac9995b4c763e323b7d7f36b8dfee2.07.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr5d4_agent1/directline/token?api-version=2022-03-01-preview'
        );
        const apiVersion = tokenEndpointURL.searchParams.get('api-version');
        const locale = document.documentElement.lang || 'en';
        const watermark = 1;

        let token, directLineURL;

        const cache = JSON.parse(sessionStorage.getItem(cacheKey) || '{}');

        if (!cache.token || !cache.directLineURL) {
          console.log("ðŸ” Fetching new token and DirectLine URL for", incidentId);

          [directLineURL, token] = await Promise.all([
            fetch(new URL(`/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`, tokenEndpointURL))
              .then(response => {
                if (!response.ok) throw new Error('Failed to retrieve regional channel settings.');
                return response.json();
              })
              .then(({ channelUrlsById: { directline } }) => directline),
            fetch(tokenEndpointURL)
              .then(response => {
                if (!response.ok) throw new Error('Failed to retrieve Direct Line token.');
                return response.json();
              })
              .then(({ token }) => token)
          ]);

          sessionStorage.setItem(cacheKey, JSON.stringify({
            token,
            directLineURL
          }));
        } else {
          token = cache.token;
          directLineURL = cache.directLineURL;
        }

        const conversationId = cache.conversationId;

        let directLine;
        if (conversationId) {
          console.log("â™»ï¸ Rehydrating chat for", incidentId);
          directLine = WebChat.createDirectLine({
            domain: new URL('v3/directline', directLineURL),
            token,
            conversationId,
            watermark
          });
        } else {
          console.log("ðŸ†• Starting new conversation for", incidentId);
          directLine = WebChat.createDirectLine({
            domain: new URL('v3/directline', directLineURL),
            token,
            watermark
          });
        }

        const subscription = directLine.connectionStatus$.subscribe({
          next(value) {
            if (value === 2) {
              if (!conversationId && directLine.conversationId) {
                const updated = JSON.parse(sessionStorage.getItem(cacheKey) || '{}');
                updated.conversationId = directLine.conversationId;
                sessionStorage.setItem(cacheKey, JSON.stringify(updated));
              }

              directLine.postActivity({
                localTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                locale,
                name: 'startConversation',
                type: 'event'
              }).subscribe();

              subscription.unsubscribe();
            }
          }
        });

        WebChat.renderWebChat(
          {
            directLine,
            locale,
            styleOptions
          },
          document.getElementById('webchat')
        );

        // Inject Prompt Buttons
        const promptMessages = [
          "What can you help me with?",
          "Show me the incident details.",
          "Reset the conversation.",
          "I need help with a ticket."
        ];
        const clipboardContainer = document.getElementById('clipboard-prompts');
        promptMessages.forEach(msg => {
          const btn = document.createElement('button');
          btn.innerText = msg;
          btn.onclick = () => {
            directLine.postActivity({
              type: 'message',
              from: { id: 'user' },
              text: msg
            }).subscribe();
          };
          clipboardContainer.appendChild(btn);
        });
      })();
    </script>
  </body>
</html>
